<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
<title>Issue Tracking System</title>
{{> include/header}}
</head>
<body>
	<div class="issues issues--wrap mdl-layout mdl-js-layout has-drawer is-upgraded">
		{{> include/topNav}}
		<main class="mdl-layout__content">
		<div class="issues-back">
			<a href="/" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon back-btn" title="go back" role="button">
			<i class="material-icons" role="presentation">arrow_back</i>
			</a>
		</div>
		 {{#issue}}
		<div class="issues__posts mdl-grid">
			<div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">
				{{#isOwner}}
				<form id="deleteForm" method="post" action="/issue/{{id}}">
					<input type="hidden" name="_method" value="delete" />
				</form>
				<div class="mdl-card__menu">
					<a href='/issue/{{id}}/edit' class="mdl-button mdl-button--icon mdl-js-button mdl-js-ripple-effect">
					<i class="material-icons">edit</i>
					</a>
					<a href='#' onclick='document.forms["deleteForm"].submit(); return false;' id="issues-menu-lower-right"	class="mdl-button mdl-js-button mdl-button--icon">
					<i class="material-icons">delete</i>
					</a>
				</div>
				{{/isOwner}}
				<div class="mdl-card__title mdl-color-text--grey-50">
					<i class="material-icons">check_circle</i>
					<h2 class="mdl-card__title-text">{{subject}} #1</h2>
				</div>

				<div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">
					<img class="minilogo" height="48" width="48"
						src="https://avatars2.githubusercontent.com/u/520500?v=3&s=140"
						alt="javajigi">
					<div style="margin-right: 20px;">
						<div class="author-text">
							<strong> <a href="https://github.com/javajigi"
								class="author">{{writer}}</a>
							</strong>
						</div>
						<span>{{date}}</span>
					</div>
					<a href="/issue/1/setOpen" class="mdl-button mdl-button--colored mdl-js-button"> Close issue </a>
					<div class="section-spacer"></div>
					<button id="milestone-menu" class="mdl-button mdl-js-button">Milestone</button>
					<!-- milestone list -->
					<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="milestone-menu">
					
					{{#milestone}}
					<form class="milestone" id="milestone{{id}}" method="post" action="/api/{{issue.id}}/milestone/{{id}}">
						<input type="hidden" name="_method" value="put" />
						<a id="submitBtn" onclick="document.getElementById('milestone{{id}}').submit();">
							<li class="mdl-menu__item">{{subject}}</li>
						</a>
					</form>
					
					{{/milestone}}
					<!-- example -->
					<!--
						<li class="mdl-menu__item mdl-button--accent"><a href="/issue/1/setMilestone/0">Milestone1</a></li>
						<li class="mdl-menu__item"><a href="/issue/1/setMilestone/2">Milestone2</a></li>
					-->
					<!-- /example -->
					</ul>

					<button id="label-menu" class="mdl-button mdl-js-button">Label</button>
					<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="label-menu">
					<!-- label list -->
					{{#label}}
					<form id="label{{id}}" method="post" action="/issue/{{issue.id}}/label/{{id}}">
						<input type="hidden" name="_method" value="put" />
					</form>
					<a onclick="document.getElementById('label{{id}}').submit();">
						<li class="mdl-menu__item">{{name}}</li>
					</a>
					{{/label}}
					<!-- example -->
					<!--
					<li class="mdl-menu__item"><a href="/issue/1/setLabel/1">label1</a></li>
					</ul>
					-->
					<!-- /example -->
					</ul>

					<button id="assignee-menu" class="mdl-button mdl-js-button">Assignee</button>
					<!-- label list -->
					<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="assignee-menu">
					{{#assignee}}
					<form id="assignee{{id}}" method="post" action="/issue/{{issue.id}}/assignee/{{id}}">
						<input type="hidden" name="_method" value="put" />
					</form>
					<a onclick="document.getElementById('assignee{{id}}').submit();">
						<li class="mdl-menu__item">{{id}}</li>
					</a>
					{{/assignee}}
					<!-- example -->
					<!--
					<li class="mdl-menu__item"><a href="/issue/1/setAssignee/1">javajigi</a></li>
					</ul>
					-->
					<!-- /example -->
					</ul>
				</div>
				<div class="mdl-color-text--grey-700 mdl-card__supporting-text">
					<p>{{comment}}</p>
				</div>
				<div
					class="mdl-color-text--primary-contrast mdl-card__supporting-text comments">

					<!-- comments start -->
					{{#reply}}
					<div class="comment mdl-color-text--grey-700">
						<header class="comment__header">
							<img class="comment__avatar2" height="48" width="48"
								src="https://avatars2.githubusercontent.com/u/520500?v=3&s=140"
								alt="javajigi">
							<div class="comment__author">
								<strong> <a>{{replyWriter}}</a> <span>{{replyComment}}
										on {{replyRegDate}}</span>
										{{#file}}
										<a href="/issue/file/{{id}}" target="_blank">[view]</a>
										{{/file}}
								</strong>
							</div>
						</header>
						<hr>
					</div>
					{{/reply}}
					<div class="replyList">
					</div>
					<!-- comments end -->				
				</div>
				
				
				{{#sessionedUser}}
				<form  action="/issue/{{issue.id}}/file" enctype="multipart/form-data" method="POST">
					<div style="margin: 10px;">
						<input type="file" name="file" id="file" />
						<button class="mdl-button" type="submit">upload file</button>
					</div>
				</form>
				<div class="mdl-color-text--primary-contrast mdl-card__supporting-text new-comment">
					<form id="reply" name="reply" class="reply" action="/api/{{issue.id}}/reply" method="POST">
						<input type="hidden" name="replyWriter" value="{{sessionedUser.id}}">
						<div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
							<textarea rows=5 class="mdl-textfield__input" id="replyComment" name="replyComment"></textarea>
							<label for="replyComment" class="mdl-textfield__label">Leave a comment</label>
						</div>
						<button id="replyBtn" type="submit" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
							<i class="material-icons" role="presentation">check</i>
							<span class="visuallyhidden">add comment</span>
						</button>
					</form>
				</div>
				{{/sessionedUser}}
			</div>
		</div>
		{{/issue}}
		{{> include/bottomNav}}
		</main>
		<div class="mdl-layout__obfuscator"></div>
	</div>
	{{> include/footer}}
	<script type="text/template" id="replyTemplate">
		<div class="comment mdl-color-text--grey-700">
			<header class="comment__header">
				<img class="comment__avatar2" height="48" width="48" src="https://avatars2.githubusercontent.com/u/520500?v=3&s=140" alt="javajigi">
				<div class="comment__author">
					<strong> <a>{0}</a> <span>{1} on {2}</span> </strong>
				</div>
			</header>
			<hr>
		</div>
	</script>
	<script>
		$('.milestone #submitBtn').click(changeMilestone);
		$('#replyBtn').click(changeReply);
		
		function changeSelectedMilestone(id){
			milestoneId = milstone
			
		}
		
		function changeReply(e){
			e.preventDefault();
			console.log('click');
			var queryString = $('.reply').serialize();
			console.log(queryString);
			
			var url = $('.reply').attr('action');
			console.log(url);
			
			$.ajax({
				type: 'post',
				url: url,
				data: queryString,
				error: onReplyError,
				success: onReplySuccess
			})
		}
		
		function onReplyError(){
			console.log("Error");
		}
		
		function onReplySuccess(data, status){
			console.log("Success");
			console.log(data);
			var replyTemplate = $('#replyTemplate').html();
			var template = replyTemplate.format(data.replyWriter.id, data.replyComment, data.replyRegDate);
			$('.replyList').append(template);
			$('#replyComment').val("");
		}
		
		function changeMilestone(e){
			e.preventDefault();	
			console.log("click");
			var queryString = $('.milestone').serialize();
			console.log(queryString);
			
			var url = $(".milestone").attr("action");
			console.log(url);
			
			$.ajax({
				type: 'put',
				url: url,
				data: queryString,
				error: onError,
				success: onSuccess
			})
		}
		
		function onError(){
			console.log("Error");
		}
		
		function onSuccess(data, status){
			console.log("Success");
			console.log(data);
		}
		
		String.prototype.format = function() {
			var args = arguments;
			return this.replace(/{(\d+)}/g, function(match, number) {
				return typeof args[number] != 'undefined' ? args[number] : match;
			});
		};
	</script>
</body>
</html>
